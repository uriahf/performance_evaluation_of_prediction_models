---
title: "Performance Evaluation of Prediction Models with Binary Outcome"
author: "Uriah Finkel"
format:
  revealjs:
    theme:  [solarized, custom.scss]
    incremental: true
---

## Agenda

-   Introducing some of the most common or useful (and sometimes not so common) Performance Metrics and Curves.

-   Discussing how and when to use (and when not to use) the mentioned performance metrics.

## Code for Performance Metrics and Curves

All interactive plots in this presentation were created with [**rtichoke**](https://uriahf.github.io/rtichoke/) (I am the author üëã).

![](https://rtichoke-blog.netlify.app/gaston_rtichoke.png){width="200"}

You are also invited to explore [**rtichoke blog**](https://rtichoke-blog.netlify.app/) for reproducible examples and some theory.

## Motivation

### Why using performance metrics? ü•áü•àü•â

-   Choosing between different candidate models.
-   Choosing between candidate features
-   Choosing whether the prediction model will do more harm than good.

## Motivation

### Relevant Criteria besides Performance ü§î

-   How difficult is it to implement the model?
-   How difficult is it to explain the model?

## Categories of Performance Metrics and Curves

-   **Discrimination üññ**: Model's ability to separate between events and non-events.

-   **Calibration ‚öñÔ∏è**: Agreement between predicted probabilities and the observed outcomes.

-   **Utility üëå**: The usefulness of the model in terms of decision-making.

------------------------------------------------------------------------

::: columns
::: {.column width="50%"}
### [Green]{style="color: green;"} {style="text-align: center; font-size: 200px;"}

::: {style="height:123px; width:100%; clear:both;"}
:::

### **üôÇ** {style="text-align: center; font-size: 120px;"}
:::

::: {.column width="50%"}
### [Red]{style="color: red;"} {style="text-align: center; font-size: 200px;"}

::: {style="height:123px; width:100%; clear:both;"}
:::

### **üôÅ** {style="text-align: center; font-size: 120px;"}
:::
:::

------------------------------------------------------------------------

::: columns
::: {.column width="50%"}
### [Green]{style="color: green;"} {style="text-align: center; font-size: 200px;"}

::: {style="height: 0px; width:100%; clear:both;"}
:::

![](Maccabi_Haifa_FC_logo.svg){fig-align="center" width="200"}
:::

::: {.column width="50%"}
### [Red]{style="color: red;"} {style="text-align: center; font-size: 200px;"}

::: {style="height: 49px; width:100%; clear:both;"}
:::

![](Hapoel_Haifa_Football_Club_Logo.png){fig-align="center" width="200"}
:::
:::

# Discrimination üññ

## Discrimination üññ

This is the most known and used category of performance metrics and curves.

## [True Positives]{style="color: green;"} {.smaller}

### Infected and Predicted as Infected - [Good]{style="color: green;"}

[**üíä**]{style="font-size: 50px;"} <br> [ü§¢]{style="font-size: 50px;"}

```{r}

tibble::tribble(
  ~"type", ~"predicted_positive", ~"predicted_negative",
  "Real Positive", "TP", "FN",
  "Real Negative", "FP", "TN"
) |> 
  reactable::reactable(
    theme = reactable::reactableTheme(
      backgroundColor = "#fdf6e3"
    ),
    sortable = FALSE,
            fullWidth = FALSE,
            borderless = FALSE,
            defaultColDef = reactable::colDef(
              align = "center",
              headerStyle  = list(fontWeight = 100)
            ),
            columns = list(
              type = reactable::colDef(
                name = "",
                align = "left",
                style = list(fontWeight = 100),
                minWidth = 200
              ),
              predicted_positive = reactable::colDef(
                name = "Predicted Positive",
                style = function(value) {
                  color <- if (value == "TP") {
                    "lightgreen"
                  }
                  
                  list(fontWeight = 600, background = color)
                },
                minWidth = 200
            ),
            predicted_negative = reactable::colDef(
              name = "Predicted Negative",
              style = function(value) {
                list(fontWeight = 600)
              },
                minWidth = 200
            )
            )
  )
```

## [False Positives]{style="color: red;"} {.smaller}

### Not-Infected and Predicted as Infected - [BAD]{style="color: red;"}

[**üíä**]{style="font-size: 50px;"} <br> [ü§®]{style="font-size: 50px;"}

```{r}
 
tibble::tribble(
  ~"type", ~"predicted_positive", ~"predicted_negative",
  "Real Positive", "TP", "FN",
  "Real Negative", "FP", "TN"
) |> 
  reactable::reactable(
    theme = reactable::reactableTheme(
      backgroundColor = "#fdf6e3"
    ),
    sortable = FALSE,
            fullWidth = FALSE,
            borderless = FALSE,
            defaultColDef = reactable::colDef(
              align = "center",
              headerStyle  = list(fontWeight = 100)
            ),
            columns = list(
              type = reactable::colDef(
                name = "",
                align = "left",
                style = list(fontWeight = 100),
                minWidth = 200
              ),
              predicted_positive = reactable::colDef(
                name = "Predicted Positive",
                style = function(value) {
                  color <- if (value == "FP") {
                    "pink"
                  }
                  
                  list(fontWeight = 600, background = color)
                },
                minWidth = 200
            ),
            predicted_negative = reactable::colDef(
              name = "Predicted Negative",
              style = function(value) {
                list(fontWeight = 600)
              },
                minWidth = 200
            )
            )
  )
```

## [False Negatives]{style="color: red;"} {.smaller}

### Infected and Predicted as Not-Infected - [BAD]{style="color: red;"}

<br> [ü§¢]{style="font-size: 50px;"}

```{r}
 
tibble::tribble(
  ~"type", ~"predicted_positive", ~"predicted_negative",
  "Real Positive", "TP", "FN",
  "Real Negative", "FP", "TN"
) |> 
  reactable::reactable(
    theme = reactable::reactableTheme(
      backgroundColor = "#fdf6e3"
    ),
    sortable = FALSE,
            fullWidth = FALSE,
            borderless = FALSE,
            defaultColDef = reactable::colDef(
              align = "center",
              headerStyle  = list(fontWeight = 100)
            ),
            columns = list(
              type = reactable::colDef(
                name = "",
                align = "left",
                style = list(fontWeight = 100),
                minWidth = 200
              ),
              predicted_positive = reactable::colDef(
                name = "Predicted Positive",
                style = function(value) {
                  list(fontWeight = 600)
                },
                minWidth = 200
            ),
            predicted_negative = reactable::colDef(
              name = "Predicted Negative",
              style = function(value) {
                 color <- if (value == "FN") {
                  "pink"
                 }
                list(fontWeight = 600, background = color)
              },
                minWidth = 200
            )
            )
  )
```

## [True Negatives]{style="color: green;"} {.smaller}

### Not-Infected and Predicted as Not-Infected - [BAD]{style="color: green;"}

<br> [ü§®]{style="font-size: 50px;"}

```{r}
 
tibble::tribble(
  ~"type", ~"predicted_positive", ~"predicted_negative",
  "Real Positive", "TP", "FN",
  "Real Negative", "FP", "TN"
) |> 
  reactable::reactable(
    theme = reactable::reactableTheme(
      backgroundColor = "#fdf6e3"
    ),
    sortable = FALSE,
            fullWidth = FALSE,
            borderless = FALSE,
            defaultColDef = reactable::colDef(
              align = "center",
              headerStyle  = list(fontWeight = 100)
            ),
            columns = list(
              type = reactable::colDef(
                name = "",
                align = "left",
                style = list(fontWeight = 100),
                minWidth = 200
              ),
              predicted_positive = reactable::colDef(
                name = "Predicted Positive",
                style = function(value) {
                  list(fontWeight = 600)
                },
                minWidth = 200
            ),
            predicted_negative = reactable::colDef(
              name = "Predicted Negative",
              style = function(value) {
                 color <- if (value == "TN") {
                  "lightgreen"
                 }
                list(fontWeight = 600, background = color)
              },
                minWidth = 200
            )
            )
  )
```

------------------------------------------------------------------------

## Probability Threshold:

-   Most Performance Metrics are estimated by using a Probability Threshold in order to classify each probability to Predicted Negative (Do not Treat) or Predicted Positive (Treat üíä).\

-   This type of dichotomization is being used when the intervention carries a **potential risk** and there is a trade-off of risks between the intervention and the outcome.

## Probability Threshold:

<table>
<tbody>
<tr class="odd">
<td style="text-align: center;"><p><strong>pÃÇ</strong></p></td>
<td style="text-align: center;"><p>0.3</p></td>
<td style="text-align: center;"><p>0.6</p></td>
<td style="text-align: center;"><p>0.4</p></td>
<td style="text-align: center;"><p>0.1</p></td>
<td style="text-align: center;"><p>0.4</p></td>
<td style="text-align: center;"><p>0.7</p></td>
<td style="text-align: center;"><p>0.3</p></td>
<td style="text-align: center;"><p>0.1</p></td>
<td style="text-align: center;"><p>0.2</p></td>
<td style="text-align: center;"><p>0.1</p></td>
</tr>
<tr class="even">
<td style="text-align: center;"><p><strong>Y</strong></p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
</tr>
</tbody>
</table>

## Low Probability Threshold:

Low Probability Threshold means that I'm worried about the **outcome**:

-   I'm worried about **Prostate Cancer** ü¶Ä
-   I'm worried about **Heart Disease** üíî
-   I'm worried about **Infection** ü§¢

## Probability Threshold of 0.25

<table>
<thead>
<tr class="header">
<th style="text-align: center;"><p><strong>pÃÇ</strong></p></th>
<th style="text-align: center;"><p>0.3</p></th>
<th style="text-align: center;"><p>0.6</p></th>
<th style="text-align: center;"><p>0.4</p></th>
<th style="text-align: center;"><p>0.1</p></th>
<th style="text-align: center;"><p>0.4</p></th>
<th style="text-align: center;"><p>0.7</p></th>
<th style="text-align: center;"><p>0.3</p></th>
<th style="text-align: center;"><p>0.1</p></th>
<th style="text-align: center;"><p>0.2</p></th>
<th style="text-align: center;"><p>0.1</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><p><strong>≈∂</strong></p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
</tr>
<tr class="even">
<td style="text-align: center;"><p><strong>Y</strong></p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;"><p><span class="emoji" data-emoji="pill">üíä</span><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><span class="emoji" data-emoji="pill">üíä</span><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><span class="emoji" data-emoji="pill">üíä</span><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><span class="emoji" data-emoji="pill">üíä</span><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><span class="emoji" data-emoji="pill">üíä</span><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><span class="emoji" data-emoji="pill">üíä</span><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: center;"><p><strong>FP</strong></p></td>
<td style="text-align: center;"><p><strong>TP</strong></p></td>
<td style="text-align: center;"><p><strong>TP</strong></p></td>
<td style="text-align: center;"><p><strong>TN</strong></p></td>
<td style="text-align: center;"><p><strong>TP</strong></p></td>
<td style="text-align: center;"><p><strong>TP</strong></p></td>
<td style="text-align: center;"><p><strong>FP</strong></p></td>
<td style="text-align: center;"><p><strong>TN</strong></p></td>
<td style="text-align: center;"><p><strong>FN</strong></p></td>
<td style="text-align: center;"><p><strong>FP</strong></p></td>
</tr>
</tbody>
</table>

## High Probability Threshold:

High Probability Threshold means that I'm worried about the **Intervention**:

-   I'm worried about **Biopsy** üíâ

-   I'm worried about **Statins** üíä

-   I'm worried about **Antibiotics** üíä

## Probability Threshold of 0.55

<table>
<thead>
<tr class="header">
<th style="text-align: center;"><p><strong>pÃÇ</strong></p></th>
<th style="text-align: center;"><p>0.3</p></th>
<th style="text-align: center;"><p>0.6</p></th>
<th style="text-align: center;"><p>0.4</p></th>
<th style="text-align: center;"><p>0.1</p></th>
<th style="text-align: center;"><p>0.4</p></th>
<th style="text-align: center;"><p>0.7</p></th>
<th style="text-align: center;"><p>0.3</p></th>
<th style="text-align: center;"><p>0.1</p></th>
<th style="text-align: center;"><p>0.2</p></th>
<th style="text-align: center;"><p>0.1</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><p><strong>≈∂</strong></p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
</tr>
<tr class="even">
<td style="text-align: center;"><p><strong>Y</strong></p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><span class="emoji" data-emoji="pill">üíä</span><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><span class="emoji" data-emoji="pill">üíä</span><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: center;"><p><strong>TN</strong></p></td>
<td style="text-align: center;"><p><strong>TP</strong></p></td>
<td style="text-align: center;"><p><strong>FN</strong></p></td>
<td style="text-align: center;"><p><strong>TN</strong></p></td>
<td style="text-align: center;"><p><strong>FN</strong></p></td>
<td style="text-align: center;"><p><strong>TP</strong></p></td>
<td style="text-align: center;"><p><strong>TN</strong></p></td>
<td style="text-align: center;"><p><strong>TN</strong></p></td>
<td style="text-align: center;"><p><strong>FN</strong></p></td>
<td style="text-align: center;"><p><strong>FP</strong></p></td>
</tr>
</tbody>
</table>

## PPCR (Predicted Positives Conditional Rate):

$\begin{aligned} \ {\scriptsize \frac{\text{TP + FP}}{\text{TP + FP + TN + FN}}}\end{aligned} = \begin{aligned} \ {\scriptsize \frac{\text{Predicted Positives}}{\text{Total Population}}}\end{aligned}$

-   Sometimes we will classify each observation according to the ranking of the risk in order to prioritize high-risk patients regardless their absolute risk.

-   The implied assumption is that the highest risk might gain the highest benefit from the treatment and that the treatment does not carry a significant potential risk.

-   This type of dichotomization is being used when the organization face **Resource Constraint**. In healthcare we call it also **Risk Percentile**.

## PPCR of 0.1

<table>
<tbody>
<tr class="odd">
<td style="text-align: center;"><p><strong>pÃÇ</strong></p></td>
<td style="text-align: center;"><p>0.3</p></td>
<td style="text-align: center;"><p>0.6</p></td>
<td style="text-align: center;"><p>0.4</p></td>
<td style="text-align: center;"><p>0.1</p></td>
<td style="text-align: center;"><p>0.4</p></td>
<td style="text-align: center;"><p>0.7</p></td>
<td style="text-align: center;"><p>0.3</p></td>
<td style="text-align: center;"><p>0.1</p></td>
<td style="text-align: center;"><p>0.2</p></td>
<td style="text-align: center;"><p>0.1</p></td>
</tr>
<tr class="even">
<td style="text-align: center;"><p><strong>R</strong></p></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><p><strong>≈∂</strong></p></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;"><p><strong>Y</strong></p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>

## PPCR of 0.1

<table>
<tbody>
<tr class="odd">
<td style="text-align: center;"><p><strong>pÃÇ</strong></p></td>
<td style="text-align: center;"><p>0.3</p></td>
<td style="text-align: center;"><p>0.6</p></td>
<td style="text-align: center;"><p>0.4</p></td>
<td style="text-align: center;"><p>0.1</p></td>
<td style="text-align: center;"><p>0.4</p></td>
<td style="text-align: center;"><p>0.7</p></td>
<td style="text-align: center;"><p>0.3</p></td>
<td style="text-align: center;"><p>0.1</p></td>
<td style="text-align: center;"><p>0.2</p></td>
<td style="text-align: center;"><p>0.1</p></td>
</tr>
<tr class="even">
<td style="text-align: center;"><p><strong>R</strong></p></td>
<td style="text-align: center;"><p>5.5</p></td>
<td style="text-align: center;"><p>2</p></td>
<td style="text-align: center;"><p>3.5</p></td>
<td style="text-align: center;"><p>9</p></td>
<td style="text-align: center;"><p>3.5</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>5.5</p></td>
<td style="text-align: center;"><p>9</p></td>
<td style="text-align: center;"><p>7</p></td>
<td style="text-align: center;"><p>9</p></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><p><strong>≈∂</strong></p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
</tr>
<tr class="even">
<td style="text-align: center;"><p><strong>Y</strong></p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><span class="emoji" data-emoji="pill">üíä</span> <br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: center;"><p><strong>FN</strong></p></td>
<td style="text-align: center;"><p><strong>FP</strong></p></td>
<td style="text-align: center;"><p><strong>FP</strong></p></td>
<td style="text-align: center;"><p><strong>FN</strong></p></td>
<td style="text-align: center;"><p><strong>FP</strong></p></td>
<td style="text-align: center;"><p><strong>TP</strong></p></td>
<td style="text-align: center;"><p><strong>FN</strong></p></td>
<td style="text-align: center;"><p><strong>FN</strong></p></td>
<td style="text-align: center;"><p><strong>FP</strong></p></td>
<td style="text-align: center;"><p><strong>FN</strong></p></td>
</tr>
</tbody>
</table>

## Discrimination - Performance Curves

| Curve             | Sens | Spec | PPV | PPCR | Lift |
|:------------------|:----:|:----:|:---:|:----:|:----:|
| ROC               |  y   |  x   |     |      |      |
| Lift              |      |      |     |  x   |  y   |
| Precision- Recall |  x   |      |  y  |      |      |
| Gains             |  y   |      |     |  x   |      |

## ROC Curve

| Curve             | Sens  | Spec  | PPV | PPCR | Lift |
|:------------------|:-----:|:-----:|:---:|:----:|:----:|
| **ROC**           | **y** | **x** |     |      |      |
| Lift              |       |       |     |  x   |  y   |
| Precision- Recall |   x   |       |  y  |      |      |
| Gains             |   y   |       |     |  x   |      |

## ROC Curve

-   The most famous form of Performance Metrics Visualization

-   Displays Sensitivity (also known as True Positive Rate or Percision) on the y axis

-   Displays 1 - Specificity (also known as False Positive Rate) on the x axis.

## Why I don't like ROC Curve üò§

### Why 1 - Specificity? Why not just Specificity? üôÉ

Honestly, I didn't find anywhere why *1 - Specificity* is more insightful than just *Specificity.*

```{r}
library(rtichoke)

performance_data <- prepare_performance_data(
  probs = list(example_dat$estimated_probabilities),
  reals = list(example_dat$outcome)
)

reference_lines <- rtichoke:::create_reference_lines_data_frame(
  "roc")

roc_curve <- performance_data  |>  
  rtichoke:::create_ggplot_for_performance_metrics(
    "FPR", "sensitivity", "black")  |>  
  rtichoke:::add_reference_lines_to_ggplot(
    reference_lines) + 
  ggplot2::xlab("1 - Specificity") + 
  ggplot2::ylab("Sensitivity")


roc_curve_opposite <- performance_data  |>  
  rtichoke:::create_ggplot_for_performance_metrics(
    "specificity", "sensitivity", "black")  |>  
  rtichoke:::add_reference_lines_to_ggplot(
    reference_lines) + 
  ggplot2::xlab("Specificity") + 
  ggplot2::ylab("Sensitivity")

roc_curve
```

## Why I don't like ROC Curve üò§

### Why 1 - Specificity? Why not just Specificity? üôÉ

Honestly, I didn't find anywhere why *1 - Specificity* is more insightful than just *Specificity.*

```{r}
roc_curve_opposite
```

## Why I don't like ROC Curve üò§

### Sensitivity and Specificity do not respect the flow of time üï∞Ô∏è

![](real_positives_future.jpg)

## Why I don't like ROC Curve üò§

### Sensitivity and Specificity do not respect the flow of time üï∞Ô∏è {.smaller}

<br>

Sensitivity: $\begin{aligned} \ {\scriptsize \frac{\text{TP}}{\text{TP + FN}} = \text{Prob( Predicted Positive | Real Positive )}}\end{aligned}$

<br>

Specificity: $\begin{aligned} \ {\scriptsize \frac{\text{TN}}{\text{TN + FP}} = \text{Prob( Predicted Negative | Real Negative )} } \end{aligned}$

<br>

We do not know the condition of the Conditional Probability: Not the number of future Real Positives nor the number of future Real Negatives.

## Why I don't like ROC Curve üò§

### Sensitivity and Specificity do not respect the flow of time üï∞Ô∏è {.smaller}

<br>

PPV: $\begin{aligned} \ {\scriptsize \frac{\text{TP}}{\text{TP + FP}} = \text{Prob( Real Positive | Predicted Positive )}}\end{aligned}$

<br>

NPV: $\begin{aligned} \ {\scriptsize \frac{\text{TN}}{\text{TN + FN}} = \text{Prob( Real Negative | Predicted Negative )} } \end{aligned}$

We know the condition of the Conditional Probability: The number of Predicted Positives and the number of Predicted Negatives.

## Why I don't like ROC Curve üò§

### You don't care about AUROC, you care about the c-statistics

-   Generally speaking more area under a curve with two "Good" performance metrics means better model. Other than that, there is no context and performance metrics with no context might lead to ambiguity and bad decisions.

-   Another Curve: Precision-Recall is made of Sensitivity (Precision) and PPV (Recall). How much PRAUC is enough?

## Why I don't like ROC Curve üò§

### You don't care about AUROC, you care about the c-statistics

-   Why not calculating GAINSAUC? Or any combination of two good performance metrics? We can get with Sensitivity, Specificity, NPV, PPV 6 AUC metrics. Do they provide any meaningful insight besides a vague *the more the better*?

## What is the AUROC of the following Models?

```{r}
set.seed(123)
library(rtichoke)
library(ggplot2)

second_model_probs <- c(
  example_dat$estimated_probabilities[1:100],
  sample(example_dat$estimated_probabilities, size = 50)
)

create_roc_curve(
  probs = list(
    "First Model" = example_dat$estimated_probabilities,
    "Second Model" = second_model_probs
  ),
  reals = list(example_dat$outcome),
  interactive = FALSE
) +
  theme(
    plot.background = element_rect(fill = "#fdf6e3"),
    panel.background = element_rect(fill = "#fdf6e3",
                                colour = "#fdf6e3"),
    panel.border = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
         strip.background = element_blank()
  ) +
  coord_fixed()

```

## What is the AUROC of the following Models?

![](khaby.gif)

```{r}
library(reactable)

options(reactable.theme = reactableTheme(
  backgroundColor = "#fdf6e3"
))

rtichoke:::create_table_for_auc(
  probs = list(
    "First Model" = example_dat$estimated_probabilities,
    "Second Model" = second_model_probs
  ),
  reals = list(example_dat$outcome)
)
```

## Why I don't like ROC Curve üò§

### You don't care about AUROC, you care about the c-statistics

-   High Ink-to-information ratio üòµ

-   One might suggest that the visual aspect is useful, but as human beings we are really bad at interpreting round things (That's why pie-charts are considered to be bad practice).

<!-- -->

-   Yet, the AUROC is valuable because of the equivalence to the c-statistics and it might provide good intuition about the performance of the model.

## Why I don't like ROC Curve üò§

### You don't care about AUROC, you care about the c-statistics

-   If you'll take randomly one event and one non-event, the probability that the event will be estimated with higher probability is exactly the AUROC.

-   AUROC = p( pÃÇ(ü§®) \> pÃÇ(ü§¢) )

## Why I don't like ROC Curve üò§

### You don't care about AUROC, you care about the c-statistics

```{r}
#| echo: true
probs <- c(0.3, 0.6, 0.4, 0.1, 0.4, 0.7, 0.3, 0.1, 0.2, 0.1)
reals <- c(0, 1, 1, 0, 1, 1, 0, 0, 1, 0)

pROC::auc(reals, probs)

probs_events <- probs[reals == 1]
probs_nonevents <- probs[reals == 0]

prop.table(
  table(
    sample(probs_events, replace = TRUE, size = 10000) >
    sample(probs_nonevents, replace = TRUE, size = 10000)
  )
)
```

## Why I don't like ROC Curve üò§

### You don't care about AUROC, you care about the c-statistics

```{python}
#| echo: true
import numpy as np
import random

probs = np.array([0.3, 0.6, 0.4, 0.1, 0.4, 0.7, 0.3, 0.1, 0.2, 0.1])
reals = np.array([0, 1, 1, 0, 1, 1, 0, 0, 1, 0])

probs_events = probs[reals == 1]
probs_nonevents = probs[reals == 0]

event_prob_greater_than_nonevent_prob = np.greater(
  random.choices(sorted(probs_events), 
  k = 10000),
  random.choices(sorted(probs_nonevents), 
  k = 10000)
)

unique_elements, counts_elements = np.unique(
  event_prob_greater_than_nonevent_prob, return_counts=True)

counts_elements / 10000

```

## Good AUROC does not necessarily mean a Good model

<table style="width:99%;">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><p>Age</p></th>
<th style="text-align: center;"><p>64</p></th>
<th style="text-align: center;"><p>86</p></th>
<th style="text-align: center;"><p>56</p></th>
<th style="text-align: center;"><p>7</p></th>
<th style="text-align: center;"><p>78</p></th>
<th style="text-align: center;"><p>85</p></th>
<th style="text-align: center;"><p>6</p></th>
<th style="text-align: center;"><p>12</p></th>
<th style="text-align: center;"><p>67</p></th>
<th style="text-align: center;"><p>73</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><p><strong>pÃÇ</strong></p></td>
<td style="text-align: center;"><p>0.3</p></td>
<td style="text-align: center;"><p>0.6</p></td>
<td style="text-align: center;"><p>0.4</p></td>
<td style="text-align: center;"><p>0.1</p></td>
<td style="text-align: center;"><p>0.4</p></td>
<td style="text-align: center;"><p>0.7</p></td>
<td style="text-align: center;"><p>0.3</p></td>
<td style="text-align: center;"><p>0.1</p></td>
<td style="text-align: center;"><p>0.2</p></td>
<td style="text-align: center;"><p>0.1</p></td>
</tr>
<tr class="even">
<td style="text-align: center;"><p><strong>Y</strong></p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
</tr>
</tbody>
</table>

AUROC shows how well your model discriminates between events and non-events given a target population.

## Good AUROC does not necessarily mean a Good model

<table style="width:99%;">
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><p>Age</p></th>
<th style="text-align: center;"><p>64</p></th>
<th style="text-align: center;"><p>86</p></th>
<th style="text-align: center;"><p>56</p></th>
<th style="text-align: center;"><p>7</p></th>
<th style="text-align: center;"><p>78</p></th>
<th style="text-align: center;"><p>85</p></th>
<th style="text-align: center;"><p>6</p></th>
<th style="text-align: center;"><p>12</p></th>
<th style="text-align: center;"><p>67</p></th>
<th style="text-align: center;"><p>73</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><p><strong>pÃÇ</strong></p></td>
<td style="text-align: center;"><p>0.3</p></td>
<td style="text-align: center;"><p>0.6</p></td>
<td style="text-align: center;"><p>0.4</p></td>
<td style="text-align: center;"><p>0.1</p></td>
<td style="text-align: center;"><p>0.4</p></td>
<td style="text-align: center;"><p>0.7</p></td>
<td style="text-align: center;"><p>0.3</p></td>
<td style="text-align: center;"><p>0.1</p></td>
<td style="text-align: center;"><p>0.2</p></td>
<td style="text-align: center;"><p>0.1</p></td>
</tr>
<tr class="even">
<td style="text-align: center;"><p><strong>Y</strong></p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>0</p></td>
<td style="text-align: center;"><p>1</p></td>
<td style="text-align: center;"><p>0</p></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="older_woman">üëµ</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="child">üßí</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="older_woman">üëµ</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="child">üßí</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="child">üßí</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="nauseated_face">ü§¢</span></p></td>
<td style="text-align: center;"><p><br />
<span class="emoji" data-emoji="raised_eyebrow">ü§®</span></p></td>
</tr>
</tbody>
</table>

This model has AUROC = 0.92, but the number is misleading:\
The Target Population is not well defined.

## Bad AUROC does not necessarily mean a Bad model

+-------+-----+-----+-----+-----+-----+
| Age   | 64  | 56  | 78  | 67  | 73  |
+:=====:+:===:+:===:+:===:+:===:+:===:+
| **pÃÇ** | 0.3 | 0.4 | 0.4 | 0.2 | 0.1 |
+-------+-----+-----+-----+-----+-----+
| **Y** | 0   | 1   | 1   | 1   | 0   |
+-------+-----+-----+-----+-----+-----+
|       | \   | \   | \   | \   | \   |
|       | ü§®  | ü§¢  | ü§¢  | ü§¢  | ü§®  |
+-------+-----+-----+-----+-----+-----+

This model has AUROC = 0.83, but the number is misleading:\
The Target Population is well defined.

## Lift Curve

| Curve             | Sens | Spec | PPV | PPCR  | Lift  |
|:------------------|:----:|:----:|:---:|:-----:|:-----:|
| ROC               |  y   |  x   |     |       |       |
| **Lift**          |      |      |     | **x** | **y** |
| Precision- Recall |  x   |      |  y  |       |       |
| Gains             |  y   |      |     |   x   |       |

## Lift Curve

-   Lift is the ratio between the PPV and the Prevalence.

-   Lift Curve displays Lift on the Y axis and PPCR (Predicted Positives Conditional Rate) on the X axis.

-   In other words, lift shows how much the prediction is doing better than a random guess in terms of PPV.

-   The reference line stands for the Lift of a random guess for a given PPCR, which is always equal to 1 because the observations are not sorted.

## Precision-Recall

| Curve             | Sens  | Spec | PPV | PPCR  | Lift |
|:------------------|:-----:|:----:|:---:|:-----:|:----:|
| ROC               |   y   |  x   |     |       |      |
| Lift              |       |      |     |   x   |  y   |
| Precision- Recall |   x   |      |  y  |       |      |
| **Gains**         | **y** |      |     | **x** |      |

## Precision Recall Curve

-   Precision-Recall Curve displays PPV on the y axis and Sensitivity on the x axis.

-   The reference line stands for the PPV of a random guess which is always equal to the prevalence and the Sensitivity of a random guess

## Gains Curve

| Curve             | Sens  | Spec | PPV | PPCR  | Lift |
|:------------------|:-----:|:----:|:---:|:-----:|:----:|
| ROC               |   y   |  x   |     |       |      |
| Lift              |       |      |     |   x   |  y   |
| Precision- Recall |   x   |      |  y  |       |      |
| **Gains**         | **y** |      |     | **x** |      |

## Gains Curve

-   Gains Curve displays Sensitivity on the y axis and PPCR on the x axis.

-   Gains shows the Sensitivity for a given PPCR.

-   The reference lines stand for

# Calibration **‚öñÔ∏è** 

## Calibration **‚öñÔ∏è**

How well the model is "calibrated".

Patients with a probability of about 0.2 to have an event have a proportion of about 0.2 events.

Unlike continuous outcomes in prediction of binary outcomes the prediction is continuous while the outcome is binary. In order to asses calibration we need to use quantiles of estimated probabilities (discrete version of calibration) or some kind of smoothing algorithm (gam or smoth).

The main idea is to visually inspect for similarty with the linear line of 45 deg.

If you use smoothed calibration, watch the ranges of the curve! It might look bad if you don't zoom-in to the reasonable range of estimated probabilities.

Why should we care?\
If you use logistic regression the model is calibrated by default, but if you use fancy ML prediction models they might not. This can be easily by remodelling of the predictions with simple logistic regression (recalibration), Python users might use <https://scikit-learn.org/stable/modules/generated/sklearn.calibration.CalibratedClassifierCV.html>.

Visual inspection might be problamatic, but from my humble experience is good enough to see if there's something inherently wrong.

Optimizing over the logloss function will produce calibrated model.

# Utility **üëå**

## Utility **üëå**

In order to make a decision, we need to optimize utility. This requires some kind of price from the clinicians.\
This price is the odds of the probability threshold.

Unlike other performance metrics, NB is based on decision making theory (which is reasonable, because we want to do better decision making).

Always consider two baseline approaches: Treat All and Treat None.
